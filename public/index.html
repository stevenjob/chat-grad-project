<!DOCTYPE html>
<html lang="en" ng-app="ChatApp">
    <head>
        <meta charset="utf-8">
        <title>Chat</title>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.1/angular.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.1/angular-aria.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.1/angular-animate.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angular_material/0.10.1/angular-material.min.js"></script>
        <script src="js/main.js"></script>
        <script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/0.10.0/angular-material.min.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="index.css">
    </head>
    <body ng-controller="ChatController">
        <md-toolbar>
            <div class="md-toolbar-tools">
                <h3>
                    Steven's Cool Chat App
                </h3>
                <div flex=""></div>
                <span class="small-icon" ng-show="loggedIn">Logged in as {{user.name || user._id}}.</span>
            </div>
        </md-toolbar>
        <md-button md-no-ink class="md-primary" ng-show="!loggedIn" ng-href={{loginUri}} >Log In</md-button>
        <md-content ng-show="loggedIn">
            <md-tabs  class="md-primary" md-selected="selectedTab" md-dynamic-height md-border-bottom>
                <md-tab label="users">
                    <md-input-container class="md-padding">
                        <label>Search users</label>
                        <input type="text" ng-model="searchUsers">
                    </md-input-container>
                    <md-content class="md-padding">
                        <md-list>
                            <!--<md-subheader class="md-no-sticky">List of registered users</md-subheader>-->
                            <md-list-item ng-repeat="otherUser in users | excludeCurrent: user._id | filter: searchUsers | orderBy:'lastMsgTime' " ng-click="addTab(otherUser)">
                                <img ng-src="{{otherUser.avatarUrl}}" class="face" >
                                <div class="full-width">
                                    <div>
                                    {{otherUser.name || otherUser.id}}
                                    </div>
                                    <div layout="row">
                                        <div flex="25">
                                            <i ng-show=otherUser.isTalking&&!otherUser.anyUnseen class="material-icons">chat_bubble_outline</i>
                                            <i ng-show=otherUser.anyUnseen class="material-icons">announcement</i>
                                        </div>
                                        <div flex="75" style="text-align: right;">{{otherUser.lastMsgTime | date: 'h:mm a d MMM'}}</div>
                                    </div>
                                </div>
                                <md-divider ng-if="!$last"></md-divider>
                            </md-list-item>
                        </md-list>
                    </md-content>
                </md-tab>
                <md-tab ng-repeat="tab in convoTabs"
                        ng-disabled="tab.disabled"
                        >
                    <md-tab-label>
                        {{tab.recipient.name || tab.recipient.id}}
                        <i class="material-icons small-icon" ng-click="removeTab(tab)">clear</i>
                    </md-tab-label>
                    <md-tab-body>
                    <div class="tab{{$index%4}}" style="padding: 25px;">
                        <div layout="row">
                            <form ng-submit="sendMessage(tab)" flex="95">
                                <md-input-container>
                                    <label>Send Message</label>
                                    <input ng-model="tab.currentMessage" type="text">
                                </md-input-container>
                            </form>
                            <md-button class="md-primary" ng-click="deleteConvo(tab)" flex="5">
                                <i class="material-icons">
                                    delete
                                </i>
                            </md-button>
                        </div>
                        <md-list>
                            <md-list-item ng-repeat="message in tab.messages">
                                <img ng-src="{{getAvatar(message)}}" class="face" >
                                <div class="full-width">
                                    <div>
                                        <b>{{message.from.name || message.from.id}}</b>
                                    </div>
                                    <div layout="row">
                                        <div flex="80" class="break-words">{{message.body}}
                                        </div>
                                        <div flex="20" style="text-align: right;">{{message.sent | date: 'h:mm a d MMM'}}</div>
                                    </div>
                                </div>
                            </md-list-item>
                        </md-list>
                        <div ng-show="tab.messages.length===0" > No Messages
                        </div>
                    </div>
                    </md-tab-body>
                </md-tab>
            </md-tabs>
        </md-content>
    </body>
</html>
